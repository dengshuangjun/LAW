<!-- 友情链接 -->
<table id="friendUrl"></table>

<!-- 添加友情链接 -->
<div id="add_FriConn" class="easyui-dialog" title="添加友情链接" data-options="iconCls:'icon-add',resizable:true,modal:true,closed:true">
	<form>
		<div style="height:200px; width:250px;margin:20px auto;">
			<label class="friConnlab">友情链接名字:</label><input type="text" id="fricon_name" name="conn_name" /><br /><br />
			<label class="friConnlab">友情链接地址:</label><input type="text" id="fricon_addr" name="conn_address" /><br /><br />
			<label class="friConnlab">友情链接权重:</label><input type="number" id="fricon_weight" name="conn_weight" min="0" required="required" value="0"><br /><br />
			<label class="friConnlab">友情链接状态:</label><select id="fricon_status" name="status" ></select><br /><br />
			<label class="friConnlab">友情链接图片:</label><input type="file" id="conn_pic" name="conn_pic" onchange="previewMultipleImage(this,'fricon_pic_show')"><br /><br />
		</div>
	</form>
	
	<div style="width:500px; height:200px; margin:0px auto;">
		<fieldset id="fricon_pic_show">
			<legend>图片预览</legend>
		</fieldset>
	</div>
	
	<a href="javascript:addFriconInfo()" class="easyui-linkbutton" data-options="iconCls:'icon-add'" style="display:block; margin:10px auto;width:80px;">添加</a>
</div>

<script> 
var editRow=undefined; //记录当期正在编辑的行
var friConnObj;
var picPath;//图片的路径
 
friConnObj = $('#friendUrl').datagrid({
	url : 'friendUrl/findUrl',
	fitColumns : true,//true将自动扩展/收缩columns大小适应grid的宽度,防止水平滚动.
	striped : true,//显示条纹所在行
	loadMsg : "数据加载中...",//当从远程服务器加载数据的时候,显示的提示消息.
	pagination : true,//分页
	fit : true,//满屏
	pageNumber : 1,//初始页码
	pageSize : 10,//分页大小
	pageList : [ 10, 20, 30, 40, 50 ],//设置属性
	sortName : 'conn_weight',//定义那个列可以排序.
	sortOrder : 'desc',
	remoteSort : false,//定义是否远程排序.对数据库进行操作
	columns : [ [ {
		field : 'cconid',
		title : '',
		width : 20,
		align : 'center',
		checkbox : true
	}, {
		field : 'conn_id',
		title : '链接编号',
		width : 60,
		align : 'center'
	}, {
		field : 'conn_name',
		title : '链接名',
		width : 100,
		align : 'center'
	}, {
		field : 'conn_address',
		title : '链接地址',
		width : 240,
		align : 'center'
	}, {
		field : 'conn_weight',
		title : '链接权重',
		width : 120,
		align : 'center',
		sortable:true,
		formatter: function(value,row,index){
			var str="";
			str+=value+"<a href='javascript:setWeight("+row.conn_id+",1,"+row.conn_weight+")' style='margin-left:4px;'>置顶</a>"+
			"<a href='javascript:setWeight("+row.conn_id+",2,"+row.conn_weight+")' style='margin-left:4px;'>上移</a>"+
			"<a href='javascript:setWeight("+row.conn_id+",3,"+row.conn_weight+")' style='margin-left:4px;'>下移</a>"
			return str; 
		}
	}, {
		field : 'status',
		title : '链接状态',
		width : 60,
		align : 'center',
		formatter: function(value,rowData,index){
			if(rowData.status == "Y"){
				return '<select><option onclick="changeFriStatus('+'\'Y\','+rowData.conn_id+')">可用</option><option onclick="changeFriStatus('+'\'N\','+rowData.conn_id+')">不可用</option></select>';
			}else if(rowData.status == "N"){
				return '<select><option onclick="changeFriStatus('+'\'N\','+rowData.conn_id+')">不可用</option><option onclick="changeFriStatus('+'\'Y\','+rowData.conn_id+')">可用</option></select>';
			}
		}
	}, {
		field : 'conn_pic',
		title : '链接图片',
		width : 200,
		align : 'center',
		formatter: function(value,rowData,index){
			if(value!=null && value!="" && value!="NULL"){
				return showPrePic(value);
			}else{
				return;
			}
		}
	} ] ],
	toolbar:[{
		text:"添加",
		iconCls:"icon-add",
		handler:function(){
			$('#add_FriConn').dialog('open');
		}
	}/* ,{
		text:"修改",
		iconCls:"icon-edit",
		handler:function(){
			var rows=friConnObj.datagrid("getChecked");
			var row=friConnObj.datagrid("getChecked")[0];
			if(rows.length>1||rows.length<=0){
				$.messager.alert('友情提示','请选择一行数据进行修改','error');
			}else{
				if(editRow!=undefined){
					if(editRow!=undefined){  //说明有行正在被编辑
						friConnObj.datagrid("rejectChanges"); //回滚所有的数据
						friConnObj.datagrid("endEdit",editRow); //关闭正在被编辑的行
						editRow=undefined;
					}
				}else{
					var option="<option value='"+row.law_group_id+"'>"+row.law_group_id+"</option>";
					$("#group_upid").append($(option));
					$('#group_upleader').val(row.law_group_leader);
					$('#group_uptitle').val(row.law_group_name);
					upUe.setContent(row.law_group_introduce);
					//修改的图片路径
					picPath = row.law_group_srouce_path;
					if( null != picPath && "" != picPath){
						$('#group_pic_show1').html(showPrePic(picPath));
					}
					$('#update_group').dialog('open');
				}
			}
		}
	},{
		text:"删除",
		iconCls:"icon-remove",
		handler:function(){
			//获取选中的行   可以删除多行
			var rows=friConnObj.datagrid("getChecked");
			if(rows.length>=1){
				$.messager.confirm('信息确认','您确定要删除选中的社团吗？',function(rs){  
				    if (rs){  
				        var gids="";
				        for(var i=0;i<rows.length-1;i++){
				        	gids+=rows[i].law_group_id+",";
				        }
				        gids+=rows[i].law_group_id;
				        
				        //发请求到数据库删除
				        $.post("../../GroupServlet",{op:"delGroup",gid:gids},function(data){
				        	if(data>0){
				        		$.messager.show({
									title:'成功提示',
									msg:'社团删除成功！！！',
									timeout:2000,
									showType:'slide'
								});
				        		rows=null;
				        		friConnObj.datagrid("reload");//刷新表格
				        	}else{
				        		$.messager.alert('失败提示','社团删除失败！！！','error');
				        	}
				        });
				    }else{
				    	return;
				    }
				});
				
			}else{
				$.messager.alert('友情提示','请至少选择一行数据进行删除操作','error');
			}
		}
	},{
		text:"撤销",
		iconCls:"icon-redo",
		handler:function(){
			friConnObj.datagrid("rejectChanges");//回滚所有数据
		}
	} */]
});

//初始化
$(function(){
	var friStus=$("#fricon_status");
	var opt;
	opt= '<select><option value="Y">可用</option><option value="N">不可用</option></select>';
	friStus.append(opt);
});


//设置预览和修改时的图片显示
function showPrePic(value){
	if(value!=undefined){
		var str="";
		var pics=value.split(",");
		for(var i=0;i<pics.length;i++){
			str+="<img src='../../"+pics[i]+"' width='60px' height='60px'/>&nbsp;";
		}
		return str;
	}
}

//设置权重
function setWeight(conId,num,weight){
	$.post("friendUrl/setWeight",{conId:conId,num:num,weight:weight},function(data){
		if(data==1){
			friConnObj.datagrid("reload");//刷新表格
			$.messager.show({
				title:'成功提示',
				msg:'权重更新成功！！！',
				timeout:2000,
				showType:'slide'
			});
		}else if(data==0){
			$.messager.alert('温馨提示','当前已在最顶部...','warning');
		}else if(data==2){
			$.messager.alert('温馨提示','当前已在最底部...','warning');
		}else if(data==3){
			$.messager.alert('温馨提示','修改权限失败...','error');
		}
	});
}

//修改友情链接状态
function changeFriStatus(status,fid){
	$.post("friendUrl/setStatus",{status:status,fid:fid},function(data){
		if(data>0){
			//friConnObj.datagrid("reload");//刷新表格
			$.messager.show({
				title:'成功提示',
				msg:'状态更新成功！！！',
				timeout:2000,
				showType:'slide'
			});
		}else {
			$.messager.alert('温馨提示','修改状态失败...','error');
		}
	});
}

//添加友情链接
function addFriconInfo(){
	var conn_name = $.trim($("#fricon_name").val());
	var conn_address = $.trim($("#fricon_addr").val());
	var conn_weight = $.trim($("#fricon_weight").val());
	var status = $.trim($("#fricon_status").val());
	
	$.ajaxFileUpload({
		url:"friendUrl/addFriConn",
		secureuri:false,
		fileElementId:"conn_pic",
		dataType:"json",
		data:{conn_name:conn_name,conn_address:conn_address,conn_weight:conn_weight,status:status},
		success:function(data,status){
			if(data>0){
				
			}else{
				$.messager.alert("错误提示","友情链接添加失败\n","error");
			}
		},
		error:function(data,status,e){
			$.messager.alert("错误提示","友情链接添加失败\n"+e,"error");
		}
	});
	
	/* $.post("friendUrl/addFriConn",{status:status,fid:fid},function(data){
		if(data>0){
			//friConnObj.datagrid("reload");//刷新表格
			$.messager.show({
				title:'成功提示',
				msg:'状态更新成功！！！',
				timeout:2000,
				showType:'slide'
			});
		}else {
			$.messager.alert('温馨提示','修改状态失败...','error');
		}
	}); */
}
</script>